{% extends "admin/change_form.html" %}
{% load i18n admin_urls static %}

{% block after_field_sets %}
{% if original %}
<div class="module aligned">
    <h2>发送消息给AI</h2>
    <form method="post" action="{% url 'admin:chat_history_conversation_send_message' original.pk %}" id="send-message-form">
        {% csrf_token %}
        <div class="form-row">
            <div>
                {{ message_form.message.label_tag }}
                {{ message_form.message }}
            </div>
        </div>
        <div class="submit-row">
            <input type="submit" value="发送消息" class="default" name="_send_message">
        </div>
    </form>
</div>
{% endif %}
{{ block.super }}
{% endblock %}

{% block admin_change_form_document_ready %}
{{ block.super }}
{% if original %}
<script>
(function($) {
    // 添加一些JavaScript来处理表单提交后的页面刷新
    $('#send-message-form').on('submit', function(e) {
        e.preventDefault();
        $.ajax({
            type: 'POST',
            url: $(this).attr('action'),
            data: $(this).serialize(),
            success: function() {
                // 提交成功后刷新页面以显示新消息
                window.location.reload();
            },
            error: function(xhr, status, error) {
                alert('发送消息时出错: ' + error);
            }
        });
    });
})(django.jQuery);
</script>
{% endif %}
{% endblock %}